name: Software Verification System

on:
  push:
    # tags:
      # - 'v*'
    branches: [ "main" ]
  # pull_request:
  #   branches: [ "main" ]

  workflow_dispatch:

env:
  MSBUILD_PATH: ''

jobs:
  Build-And-Analysis:
    runs-on: windows-latest
    
    permissions:
      security-events: write
      actions: write
      contents: write

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Coverity ë¼ì´ì„ ìŠ¤ íŒŒì¼ ìƒì„±
        shell: pwsh
        env:
          COVERITY_LICENSE_CONTENT: ${{ secrets.COVERITY_ANALYSIS_LICENSE }} # Secretsì—ì„œ ë¼ì´ì„ ìŠ¤ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        run: |
          $licenseFileName = "license.dat"
          $licenseFilePath = "./$licenseFileName" # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬(ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸)ì— ì €ì¥

          if ([string]::IsNullOrWhiteSpace($env:COVERITY_LICENSE_CONTENT)) {
              Write-Error "ERROR: 'COVERITY_ANALYSIS_LICENSE' secretì´ ë¹„ì–´ìˆê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              Write-Host "GitHub ì €ì¥ì†Œì˜ Settings -> Secrets and variables -> Actions ì— 'COVERITY_ANALYSIS_LICENSE' secretì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
              exit 1
          }

          # ë¼ì´ì„ ìŠ¤ ë‚´ìš©ì„ íŒŒì¼ì— ì”ë‹ˆë‹¤.
          # -NoNewlineì„ ì‚¬ìš©í•˜ì—¬ Secret ê°’ ëì— ë¶ˆí•„ìš”í•œ ìƒˆ ì¤„ì´ ì¶”ê°€ë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
          $env:COVERITY_LICENSE_CONTENT | Out-File -FilePath $licenseFilePath -Encoding UTF8 -NoNewline
          
          if (-not (Test-Path $licenseFilePath)) {
              Write-Error "ERROR: ë¼ì´ì„ ìŠ¤ íŒŒì¼($licenseFilePath) ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
              exit 1
          }
          Write-Host "ë¼ì´ì„ ìŠ¤ íŒŒì¼($licenseFilePath)ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          # ë³´ì•ˆì„ ìœ„í•´ ë¼ì´ì„ ìŠ¤ íŒŒì¼ì˜ ë‚´ìš©ì€ ë¡œê·¸ì— ì¶œë ¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

          Write-Host "`n==== ìƒì„±ëœ ë¼ì´ì„ ìŠ¤ íŒŒì¼ í™•ì¸ ===="
          # íŠ¹ì • íŒŒì¼ë§Œ í™•ì¸ (ê¶Œì¥)
          Get-ChildItem -Path $licenseFilePath | Format-Table Name, Length, LastWriteTime -AutoSize
          # ë˜ëŠ” í˜„ì¬ ë””ë ‰í† ë¦¬ ì „ì²´ íŒŒì¼ ëª©ë¡ì—ì„œ ì°¾ê¸°
          Get-ChildItem -Path "./" -File | Where-Object {$_.Name -eq $licenseFileName} | Format-Table Name, Length, LastWriteTime -AutoSize
          Write-Host "==============================="


      - name: Coverity Installer Download from HTTP Server
        shell: pwsh
        env:
          # ì—¬ê¸°ì— ì‹¤ì œ ì„œë²„ URL ë° íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.
          INSTALLER_DOWNLOAD_URL: http://160.187.202.144/downloads/cov-analysis-win64-2024.12.1.exe 
          # ë‹¤ìš´ë¡œë“œë  íŒŒì¼ì˜ ë¡œì»¬ ê²½ë¡œ ë° ì´ë¦„ (ì›Œí¬í”Œë¡œìš° ì‘ì—… ë””ë ‰í† ë¦¬ ê¸°ì¤€)
          LOCAL_INSTALLER_PATH: cov-analysis-win64-2024.12.1.exe 
        run: |
          # ğŸš¨ğŸš¨ ì¤‘ìš” ê²½ê³  ğŸš¨ğŸš¨
          # ì´ URLì€ ë°˜ë“œì‹œ GitHub Actions Runnerì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ê³µê°œì ì¸ URLì´ì–´ì•¼ í•©ë‹ˆë‹¤.
          # ì‚¬ì„¤ IP ì£¼ì†Œë‚˜ ë‚´ë¶€ë§ ë„ë©”ì¸ì€ ì ‘ê·¼í•  ìˆ˜ ì—†ì–´ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í•©ë‹ˆë‹¤.

          $downloadUrl = "${{ env.INSTALLER_DOWNLOAD_URL }}"
          $outputPath = "${{ env.LOCAL_INSTALLER_PATH }}"
          # ë‹¤ìš´ë¡œë“œë  íŒŒì¼ì˜ ë””ë ‰í† ë¦¬ê°€ í˜„ì¬ ì›Œí¬í”Œë¡œìš°ì˜ ì‘ì—… ë””ë ‰í† ë¦¬(ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸)ì´ë¯€ë¡œ ë³„ë„ ìƒì„± í•„ìš” ì—†ìŒ
          # ë§Œì•½ íŠ¹ì • ì„œë¸Œí´ë”(ì˜ˆ: `downloads/`)ì— ì €ì¥í•˜ë ¤ë©´:
          # $downloadDir = "downloads"
          # New-Item -ItemType Directory -Path $downloadDir -Force | Out-Null
          # $outputPath = Join-Path $downloadDir "${{ env.LOCAL_INSTALLER_PATH }}"


          Write-Host "Coverity ì„¤ì¹˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘..."
          Write-Host "URL: $downloadUrl"
          Write-Host "ì €ì¥ ìœ„ì¹˜: $outputPath"

          try {
              # Invoke-WebRequestë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
              # -Uri: ë‹¤ìš´ë¡œë“œí•  URL
              # -OutFile: ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ì„ ì €ì¥í•  ê²½ë¡œ
              # -TimeoutSec: ë‹¤ìš´ë¡œë“œ íƒ€ì„ì•„ì›ƒ (ì´ˆ). ëŒ€ìš©ëŸ‰ íŒŒì¼ì— ì¶©ë¶„íˆ í° ê°’ ì„¤ì • (ì˜ˆ: 10ë¶„ = 600ì´ˆ)
              # -ErrorAction Stop: ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
              Invoke-WebRequest -Uri $downloadUrl -OutFile $outputPath -TimeoutSec 600 -ErrorAction Stop

              if (-not (Test-Path $outputPath)) {
                  throw "íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              }
              Write-Host "`níŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ!"
              Write-Host "ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ í¬ê¸°: $((Get-Item $outputPath).Length / 1MB) MB"
          }
          catch {
              Write-Error "`níŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)"
              Write-Error "URL ($downloadUrl)ì´ GitHub Runnerì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œì§€, ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œê°€ ì—†ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
              exit 1
          }

          # (ì„ íƒ ì‚¬í•­: ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ ëª©ë¡ í™•ì¸)
          Write-Host "`n==== ë‹¤ìš´ë¡œë“œ í›„ í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡ ===="
          Get-ChildItem -Path "./" -File | Format-Table Name, Length, LastWriteTime -AutoSize
          Write-Host "============================"


      - name: ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ (GB ë‹¨ìœ„)
        shell: pwsh
        run: |
          Write-Host "==== í˜„ì¬ ëŸ¬ë„ˆì˜ ë””ìŠ¤í¬ ê³µê°„ (GB ë‹¨ìœ„) ===="
          Get-PSDrive -PSProvider FileSystem | Select-Object Name, Root, @{Name='Free(GB)'; Expression={$_.Free / 1GB -as [int]}}, @{Name='Used(GB)'; Expression={$_.Used / 1GB -as [int]}}, @{Name='Size(GB)'; Expression={$_.Size / 1GB -as [int]}} | Format-Table -AutoSize
          Write-Host "============================================="


      - name: Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ì‹¤í–‰ 
        shell: pwsh
        env:
          COVERITY_ORIGINAL_INSTALLER_NAME: cov-analysis-win64-2024.12.1.exe
        run: |
          $installerPath = "./${{ env.COVERITY_ORIGINAL_INSTALLER_NAME }}" 
          
          # -----------------------------------------------------------------
          # 1. license.dat íŒŒì¼ì˜ ì ˆëŒ€ ê²½ë¡œ êµ¬ì„±
          # -----------------------------------------------------------------
          $currentWorkingDirectory = Get-Location # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ (ì˜ˆ: D:\a\Ctest\Ctest)
          $licenseFullAbsolutePath = Join-Path $currentWorkingDirectory "license.dat"
          
          # -----------------------------------------------------------------
          # 2. Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ìì²´ ë¡œê·¸ íŒŒì¼ ê²½ë¡œ êµ¬ì„±
          # (ì´ ë¡œê·¸ íŒŒì¼ì— ì„¤ì¹˜ ì‹¤íŒ¨ì˜ ê°€ì¥ ìƒì„¸í•œ ì›ì¸ì´ ê¸°ë¡ë©ë‹ˆë‹¤. ì¸ìëª… í™•ì¸ í•„ìˆ˜!)
          # -----------------------------------------------------------------
          $coverityInstallerLogLocation = "C:\Coverity\coverity_install_verbose.log" # ì„¤ì¹˜ ê²½ë¡œì— ë¡œê·¸ ìƒì„±
          $installerLogArgument = "--log-file=`"$coverityInstallerLogLocation`"" # ì¸ìëª…ê³¼ í•¨ê»˜ ì ˆëŒ€ ê²½ë¡œ ì „ë‹¬ (ë°±í‹±ìœ¼ë¡œ ì¸ìš©ë¶€í˜¸ ì´ìŠ¤ì¼€ì´í”„)

          # -----------------------------------------------------------------
          # 3. ëª¨ë“  ì„¤ì¹˜ ì¸ìë¥¼ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ êµ¬ì„± (ì ˆëŒ€ ê²½ë¡œ í¬í•¨)
          # ì¸ìì— ê³µë°±ì´ í¬í•¨ë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ `"$ë³€ìˆ˜ëª…`"` (ë°±í‹±ê³¼ í°ë”°ì˜´í‘œ) í˜•ì‹ìœ¼ë¡œ ê°ìŒ‰ë‹ˆë‹¤.
          # -----------------------------------------------------------------
          $installerArguments = "-q -console --installation.dir=C:\\Coverity --license.region=5 --license.agreement=agree --license.type.choice=0 --license.cov.path=`"$licenseFullAbsolutePath`" $installerLogArgument"
          
          # -----------------------------------------------------------------
          # ë””ë²„ê¹… ì¶œë ¥: ìµœì¢… ì¸ì ë¬¸ìì—´ í™•ì¸ (ë§¤ìš° ì¤‘ìš”!)
          # -----------------------------------------------------------------
          Write-Host "DEBUG: ì‹¤í–‰í•  ì„¤ì¹˜ íŒŒì¼ ê²½ë¡œ: $installerPath"
          Write-Host "DEBUG: ì‚¬ìš©ë  ë¼ì´ì„ ìŠ¤ íŒŒì¼ ì ˆëŒ€ ê²½ë¡œ: $licenseFullAbsolutePath"
          Write-Host "DEBUG: ì‚¬ìš©ë  ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ìƒì„¸ ë¡œê·¸ ê²½ë¡œ: $coverityInstallerLogLocation"
          Write-Host "DEBUG: ì‚¬ìš©ë  ìµœì¢… ì„¤ì¹˜ ì¸ì: $installerArguments"
          Write-Host "ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ì¶œë ¥ì´ ì½˜ì†”ì— ì§ì ‘ í‘œì‹œë©ë‹ˆë‹¤. (ì£¼ì˜: ì„¤ì¹˜ í”„ë¡œê·¸ë¨ì´ ì½˜ì†” ì¶œë ¥ì„ ì œê³µí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)"
          
          # -----------------------------------------------------------------
          # 4. Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ì‹¤í–‰ (PowerShellì˜ '&' í˜¸ì¶œ ì—°ì‚°ì ì‚¬ìš©)
          # -----------------------------------------------------------------
          try {
              & "$installerPath" $installerArguments # ì§ì ‘ ì‹¤í–‰
              $exitCode = $LASTEXITCODE # ì‹¤í–‰ëœ í”„ë¡œì„¸ìŠ¤ì˜ ì¢…ë£Œ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
          } catch {
              Write-Error "Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ í˜¸ì¶œ ì¤‘ PowerShell ì˜ˆì™¸ ë°œìƒ: $($_.Exception.Message)"
              $exitCode = 9999
          }
          
          if ($exitCode -ne 0) {
              Write-Error "Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ì¢…ë£Œ ì½”ë“œ: $exitCode"
              
              # -----------------------------------------------------------------
              # 5. ì‹¤íŒ¨ ì‹œ ìƒì„¸ ë¡œê·¸ íŒŒì¼ ë‚´ìš© ì¶œë ¥ (ê°€ì¥ ì¤‘ìš”!)
              # -----------------------------------------------------------------
              Write-Host "`n==== Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ìƒì„¸ ë¡œê·¸ íŒŒì¼ ë‚´ìš© ===="
              if (Test-Path $coverityInstallerLogLocation) {
                  Get-Content $coverityInstallerLogLocation | Write-Host
              } else {
                  Write-Host "ìƒì„¸ ë¡œê·¸ íŒŒì¼ ($coverityInstallerLogLocation)ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              }
              Write-Host "===================================================="

              # (ì„ì‹œ í´ë” ë¡œê·¸ í™•ì¸ ë¡œì§ - ì´ì „ ë‹µë³€ì—ì„œ ì œê³µëœ ë¶€ë¶„. í•„ìš”ì‹œ ìœ ì§€.)
              $coveritySpecificLog2 = Join-Path $env:TEMP "coverity_installer_*.log"
              Write-Host "`n==== Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ì„ì‹œ í´ë” ë¡œê·¸ í™•ì¸ ===="
              Get-ChildItem -Path $env:TEMP -Filter "coverity_installer_*.log" | ForEach-Object {
                  Write-Host "ì„ì‹œ í´ë” ë¡œê·¸ ($($_.FullName)) ë‚´ìš©:"
                  Get-Content $_.FullName | Write-Host
              } | Out-Null
              Write-Host "======================================================"
              
              exit 1 # ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤íŒ¨ ì²˜ë¦¬
          }
          Write-Host "Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì™„ë£Œ."
          
          # -----------------------------------------------------------------
          # 6. ì„¤ì¹˜ í›„ Coverity CLI PATH ì„¤ì • ë° í™•ì¸
          # -----------------------------------------------------------------
          $coverityBinPath = "C:\Coverity\bin" # ì¸ìë¡œ ì§€ì •í•œ ì„¤ì¹˜ ê²½ë¡œ ê¸°ì¤€
          if (Test-Path $coverityBinPath) {
              $env:PATH += ";$coverityBinPath"
              Write-Host "Coverity CLI ê²½ë¡œê°€ PATHì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."
              cov-build --version # ì„¤ì¹˜ í™•ì¸ ëª…ë ¹ì–´
          } else {
              Write-Warning "Coverity ì„¤ì¹˜ ê²½ë¡œì— bin í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ PATHì— ì¶”ê°€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
          }