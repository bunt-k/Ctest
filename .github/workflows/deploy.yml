name: Software Verification System

on:
  push:
    # tags:
      # - 'v*'
    branches: [ "main" ]
  # pull_request:
  #   branches: [ "main" ]

  workflow_dispatch:

env:
  MSBUILD_PATH: ''
  # installer details (ì‚¬ìš©ì ì •ì˜)
  INSTALLER_DOWNLOAD_URL: http://160.187.202.144/downloads/cov-analysis-win64-2024.12.1.exe # <-- ì—¬ê¸°ì— ì‹¤ì œ ì„œë²„ URL ì…ë ¥
  INSTALLER_NAME: cov-analysis-win64-2024.12.1.exe # ë‹¤ìš´ë¡œë“œë  íŒŒì¼ëª…
  # ìºì‹œ í‚¤ì— ì‚¬ìš©í•  ì„¤ì¹˜ íŒŒì¼ì˜ ë²„ì „ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
  # installer URLì´ë‚˜ íŒŒì¼ ë‚´ìš©ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì´ ë²„ì „ì„ ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•´ì•¼ ìºì‹œê°€ ê°±ì‹ ë©ë‹ˆë‹¤.
  INSTALLER_VERSION: 2024.12.1 # <--- ì„¤ì¹˜ íŒŒì¼ì˜ ë²„ì „ì´ ë°”ë€” ë•Œë§ˆë‹¤ ì´ ê°’ì„ ë³€ê²½í•´ì£¼ì„¸ìš”!
  # ì••ì¶• í•´ì œ í›„ ìƒì„±ë  ì›ë³¸ ì„¤ì¹˜ íŒŒì¼ ì´ë¦„
  COVERITY_ORIGINAL_INSTALLER_NAME: cov-analysis-win64-2024.12.1.exe

jobs:
  Build-And-Analysis:
    runs-on: windows-latest
    
    permissions:
      security-events: write
      actions: write
      contents: write

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Coverity ë¼ì´ì„ ìŠ¤ íŒŒì¼ ìƒì„±
        shell: pwsh
        env:
          COVERITY_LICENSE_CONTENT: ${{ secrets.COVERITY_ANALYSIS_LICENSE }} # Secretsì—ì„œ ë¼ì´ì„ ìŠ¤ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        run: |
          $licenseFileName = "license.dat"
          $licenseFilePath = "./$licenseFileName" # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬(ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸)ì— ì €ì¥

          if ([string]::IsNullOrWhiteSpace($env:COVERITY_LICENSE_CONTENT)) {
              Write-Error "ERROR: 'COVERITY_ANALYSIS_LICENSE' secretì´ ë¹„ì–´ìˆê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              Write-Host "GitHub ì €ì¥ì†Œì˜ Settings -> Secrets and variables -> Actions ì— 'COVERITY_ANALYSIS_LICENSE' secretì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
              exit 1
          }

          # ë¼ì´ì„ ìŠ¤ ë‚´ìš©ì„ íŒŒì¼ì— ì”ë‹ˆë‹¤.
          # -NoNewlineì„ ì‚¬ìš©í•˜ì—¬ Secret ê°’ ëì— ë¶ˆí•„ìš”í•œ ìƒˆ ì¤„ì´ ì¶”ê°€ë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
          $env:COVERITY_LICENSE_CONTENT | Out-File -FilePath $licenseFilePath -Encoding UTF8 -NoNewline
          
          if (-not (Test-Path $licenseFilePath)) {
              Write-Error "ERROR: ë¼ì´ì„ ìŠ¤ íŒŒì¼($licenseFilePath) ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
              exit 1
          }
          Write-Host "ë¼ì´ì„ ìŠ¤ íŒŒì¼($licenseFilePath)ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          # ë³´ì•ˆì„ ìœ„í•´ ë¼ì´ì„ ìŠ¤ íŒŒì¼ì˜ ë‚´ìš©ì€ ë¡œê·¸ì— ì¶œë ¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

          Write-Host "`n==== ìƒì„±ëœ ë¼ì´ì„ ìŠ¤ íŒŒì¼ í™•ì¸ ===="
          # íŠ¹ì • íŒŒì¼ë§Œ í™•ì¸ (ê¶Œì¥)
          Get-ChildItem -Path $licenseFilePath | Format-Table Name, Length, LastWriteTime -AutoSize
          # ë˜ëŠ” í˜„ì¬ ë””ë ‰í† ë¦¬ ì „ì²´ íŒŒì¼ ëª©ë¡ì—ì„œ ì°¾ê¸°
          Get-ChildItem -Path "./" -File | Where-Object {$_.Name -eq $licenseFileName} | Format-Table Name, Length, LastWriteTime -AutoSize
          Write-Host "==============================="


      - name: Coverity Installer Download from HTTP Server
        shell: pwsh
        env:
          # ì—¬ê¸°ì— ì‹¤ì œ ì„œë²„ URL ë° íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.
          INSTALLER_DOWNLOAD_URL: http://160.187.202.144/downloads/cov-analysis-win64-2024.12.1.exe 
          # ë‹¤ìš´ë¡œë“œë  íŒŒì¼ì˜ ë¡œì»¬ ê²½ë¡œ ë° ì´ë¦„ (ì›Œí¬í”Œë¡œìš° ì‘ì—… ë””ë ‰í† ë¦¬ ê¸°ì¤€)
          LOCAL_INSTALLER_PATH: cov-analysis-win64-2024.12.1.exe 
        run: |
          # ğŸš¨ğŸš¨ ì¤‘ìš” ê²½ê³  ğŸš¨ğŸš¨
          # ì´ URLì€ ë°˜ë“œì‹œ GitHub Actions Runnerì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ê³µê°œì ì¸ URLì´ì–´ì•¼ í•©ë‹ˆë‹¤.
          # ì‚¬ì„¤ IP ì£¼ì†Œë‚˜ ë‚´ë¶€ë§ ë„ë©”ì¸ì€ ì ‘ê·¼í•  ìˆ˜ ì—†ì–´ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í•©ë‹ˆë‹¤.

          $downloadUrl = "${{ env.INSTALLER_DOWNLOAD_URL }}"
          $outputPath = "${{ env.LOCAL_INSTALLER_PATH }}"
          # ë‹¤ìš´ë¡œë“œë  íŒŒì¼ì˜ ë””ë ‰í† ë¦¬ê°€ í˜„ì¬ ì›Œí¬í”Œë¡œìš°ì˜ ì‘ì—… ë””ë ‰í† ë¦¬(ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸)ì´ë¯€ë¡œ ë³„ë„ ìƒì„± í•„ìš” ì—†ìŒ
          # ë§Œì•½ íŠ¹ì • ì„œë¸Œí´ë”(ì˜ˆ: `downloads/`)ì— ì €ì¥í•˜ë ¤ë©´:
          # $downloadDir = "downloads"
          # New-Item -ItemType Directory -Path $downloadDir -Force | Out-Null
          # $outputPath = Join-Path $downloadDir "${{ env.LOCAL_INSTALLER_PATH }}"


          Write-Host "Coverity ì„¤ì¹˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘..."
          Write-Host "URL: $downloadUrl"
          Write-Host "ì €ì¥ ìœ„ì¹˜: $outputPath"

          try {
              # Invoke-WebRequestë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
              # -Uri: ë‹¤ìš´ë¡œë“œí•  URL
              # -OutFile: ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ì„ ì €ì¥í•  ê²½ë¡œ
              # -TimeoutSec: ë‹¤ìš´ë¡œë“œ íƒ€ì„ì•„ì›ƒ (ì´ˆ). ëŒ€ìš©ëŸ‰ íŒŒì¼ì— ì¶©ë¶„íˆ í° ê°’ ì„¤ì • (ì˜ˆ: 10ë¶„ = 600ì´ˆ)
              # -ErrorAction Stop: ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
              Invoke-WebRequest -Uri $downloadUrl -OutFile $outputPath -TimeoutSec 600 -ErrorAction Stop

              if (-not (Test-Path $outputPath)) {
                  throw "íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              }
              Write-Host "`níŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ!"
              Write-Host "ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ í¬ê¸°: $((Get-Item $outputPath).Length / 1MB) MB"
          }
          catch {
              Write-Error "`níŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)"
              Write-Error "URL ($downloadUrl)ì´ GitHub Runnerì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œì§€, ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œê°€ ì—†ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
              exit 1
          }

          # (ì„ íƒ ì‚¬í•­: ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ ëª©ë¡ í™•ì¸)
          Write-Host "`n==== ë‹¤ìš´ë¡œë“œ í›„ í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡ ===="
          Get-ChildItem -Path "./" -File | Format-Table Name, Length, LastWriteTime -AutoSize
          Write-Host "============================"


      - name: ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ (GB ë‹¨ìœ„)
        shell: pwsh
        run: |
          Write-Host "==== í˜„ì¬ ëŸ¬ë„ˆì˜ ë””ìŠ¤í¬ ê³µê°„ (GB ë‹¨ìœ„) ===="
          Get-PSDrive -PSProvider FileSystem | Select-Object Name, Root, @{Name='Free(GB)'; Expression={$_.Free / 1GB -as [int]}}, @{Name='Used(GB)'; Expression={$_.Used / 1GB -as [int]}}, @{Name='Size(GB)'; Expression={$_.Size / 1GB -as [int]}} | Format-Table -AutoSize
          Write-Host "============================================="




      - name: Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ì‹¤í–‰
        shell: pwsh
        env:
          COVERITY_ORIGINAL_INSTALLER_NAME: cov-analysis-win64-2024.12.1.exe
        run: |
          # ì‹¤í–‰í•  ì„¤ì¹˜ íŒŒì¼ì˜ ì ˆëŒ€ ê²½ë¡œ (í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ì— ìˆìŒ)
          $installerPath = "./${{ env.COVERITY_ORIGINAL_INSTALLER_NAME }}" 
          
          # ë¼ì´ì„ ìŠ¤ íŒŒì¼ì˜ ì ˆëŒ€ ê²½ë¡œ (í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ì— ìˆìŒ)
          $currentWorkingDirectory = Get-Location
          $licenseFullAbsolutePath = Join-Path $currentWorkingDirectory "license.dat"
          $licensePathArgument = "--license.cov.path=`"$licenseFullAbsolutePath`""
          
          # -----------------------------------------------------------------
          # 1. ìµœì¢… ì„¤ì¹˜ ì¸ì ë¬¸ìì—´ êµ¬ì„±
          # -----------------------------------------------------------------
          $baseArguments = "-q -console --installation.dir=""C:\\Program Files\\Coverity"" --license.region=5 --license.agreement=agree --license.type.choice=0"
          $finalInstallerArguments = "$baseArguments $licensePathArgument"
          
          # -----------------------------------------------------------------
          # 2. ì‹¤í–‰ë  ì •í™•í•œ ì „ì²´ ëª…ë ¹ì–´ ë¬¸ìì—´ êµ¬ì„± ë° ì½˜ì†”ì— ì¶œë ¥ (ë””ë²„ê¹…ìš©)
          # ì´ ë¶€ë¶„ì´ ì‹¤ì œ CMDë‚˜ Bashì—ì„œ ë³µì‚¬í•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ëª…ë ¹ì–´ í˜•íƒœì…ë‹ˆë‹¤.
          # -----------------------------------------------------------------
          $fullCommandToExecute = "`"$installerPath`" $finalInstallerArguments"
          Write-Host "DEBUG: ì‹¤í–‰ë  ìµœì¢… ì„¤ì¹˜ ëª…ë ¹ì–´: $fullCommandToExecute"
          
          # -----------------------------------------------------------------
          # 3. Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ì‹¤í–‰ (PowerShellì˜ '&' í˜¸ì¶œ ì—°ì‚°ì ì‚¬ìš©)
          # -----------------------------------------------------------------
          
          # Write-Host "Coverity ì„¤ì¹˜ ì‹œì‘."
          # & "$installerPath" $finalInstallerArguments
          # $exitCode = $LASTEXITCODE
          # Write-Host "Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì™„ë£Œ."

          try {
              Write-Host "Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ë° ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
              Start-Process -FilePath "$installerPath" `
                            -ArgumentList "$finalInstallerArguments" `
                            -Wait ` # <--- ì´ ì˜µì…˜ì´ ì„¤ì¹˜ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤!
              
              $exitCode = $LASTEXITCODE # í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œëœ í›„ì˜ ì¢…ë£Œ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
          } catch {
              Write-Error "Coverity ì„¤ì¹˜ í”„ë¡œê·¸ë¨ í˜¸ì¶œ ì¤‘ PowerShell ì˜ˆì™¸ ë°œìƒ: $($_.Exception.Message)"
              $exitCode = 9999
          }
          
          # -----------------------------------------------------------------
          # Coverity ì„¤ì¹˜ ê²½ë¡œ (C:\Coverity) ë‚´ìš© í™•ì¸
          # -----------------------------------------------------------------
          $coverityInstallRoot = "C:\\Program Files" # ì„¤ì¹˜ ê²½ë¡œ ë³€ìˆ˜

          Write-Host "`n==== Coverity ì„¤ì¹˜ ê²½ë¡œ '$coverityInstallRoot' ë‚´ìš© ===="
          if (Test-Path $coverityInstallRoot) {
              # ì„¤ì¹˜ ë£¨íŠ¸ í´ë”ì˜ ë‚´ìš© í™•ì¸
              Get-ChildItem -Path $coverityInstallRoot -Force | Format-Table Name, LastWriteTime, Mode, Length -AutoSize
              
              Write-Host "`n==== '$coverityInstallRoot' í•˜ìœ„ í´ë”ì—ì„œ 'cov-build.exe' ì°¾ê¸° ===="
              # cov-build.exe íŒŒì¼ì„ í•˜ìœ„ í´ë”ì—ì„œ ì¬ê·€ì ìœ¼ë¡œ ì°¾ê¸°
              $covBuildExecutable = Get-ChildItem -Path $coverityInstallRoot -Recurse -Filter "cov-build.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
              
              if ($covBuildExecutable) {
                  Write-Host "cov-build.exe ë°œê²¬: $($covBuildExecutable.FullName)"
                  # PATHì— ì¶”ê°€í•  í´ë” (cov-build.exeê°€ ìˆëŠ” ë””ë ‰í† ë¦¬)
                  $coverityBinPath = $covBuildExecutable.DirectoryName
                  Write-Host "ìë™ìœ¼ë¡œ ì°¾ì€ Coverity CLI ê²½ë¡œ: $coverityBinPath"
              } else {
                  Write-Warning "ì„¤ì¹˜ ê²½ë¡œ '$coverityInstallRoot' ë‚´ì—ì„œ 'cov-build.exe'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„¤ì¹˜ê°€ ì˜ˆìƒê³¼ ë‹¤ë¥´ê²Œ ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                  # PATHì— ì¶”ê°€í•  ê²½ë¡œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì • (í˜¹ì‹œ ëª¨ë¥¼ ìƒí™© ëŒ€ë¹„)
                  $coverityBinPath = Join-Path $coverityInstallRoot "bin"
              }
          } else {
              Write-Error "ERROR: Coverity ì„¤ì¹˜ ê²½ë¡œ '$coverityInstallRoot'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„¤ì¹˜ê°€ ì‹¤íŒ¨í–ˆì„ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤."
              $coverityBinPath = Join-Path $coverityInstallRoot "bin" # PATH ì¶”ê°€ ì‹œë„ìš© ê¸°ë³¸ê°’
          }
          Write-Host "============================================="

          # -----------------------------------------------------------------
          # Coverity CLI PATH ì„¤ì • ë° í™•ì¸ (ìœ„ì—ì„œ ì°¾ì€ ê²½ë¡œë¥¼ ì‚¬ìš©)
          # -----------------------------------------------------------------
          if (Test-Path $coverityBinPath) { # ì°¾ì€ ê²½ë¡œê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ ë‹¤ì‹œ í™•ì¸
              $env:PATH += ";$coverityBinPath"
              Write-Host "Coverity CLI ê²½ë¡œ '$coverityBinPath'ê°€ PATHì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."
              cov-configure --msvc
          } else {
              Write-Warning "Coverity CLI ê²½ë¡œ '$coverityBinPath'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ PATHì— ì¶”ê°€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. CLI ì‚¬ìš© ë¶ˆê°€."
          }
